name: Unity PlayMode Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  playmode-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Unity
        id: setup
        uses: game-ci/unity-actions/setup@v4
        with:
          unityVersion: '6000.0.62f1'

      - name: Activate Unity license
        if: secrets.UNITY_LICENSE
        uses: game-ci/unity-actions/activate@v2
        with:
          unitySerial: ${{ secrets.UNITY_LICENSE }}

      - name: Prepare logs dir
        run: |
          mkdir -p ninja-fruit/logs

      - name: Run EditMode tests
        # Project sits in subfolder 'ninja-fruit'
        run: |
          "${{ steps.setup.outputs.editorPath }}" -projectPath $GITHUB_WORKSPACE/ninja-fruit -batchmode -runTests -testPlatform EditMode -testResults $GITHUB_WORKSPACE/ninja-fruit/logs/editmode-test-results.xml -quit

      - name: Run PlayMode tests
        run: |
          "${{ steps.setup.outputs.editorPath }}" -projectPath $GITHUB_WORKSPACE/ninja-fruit -batchmode -runTests -testPlatform PlayMode -testResults $GITHUB_WORKSPACE/ninja-fruit/logs/playmode-test-results.xml -quit

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: unity-test-results
          path: |
            ninja-fruit/logs/editmode-test-results.xml
            ninja-fruit/logs/playmode-test-results.xml
      - name: Fail on test failures
        run: |
          python3 - <<'PY'
          import sys, os
          import xml.etree.ElementTree as ET

          files = ["ninja-fruit/logs/editmode-test-results.xml", "ninja-fruit/logs/playmode-test-results.xml"]
          any_missing = False
          total_failed = 0

          for f in files:
              if not os.path.exists(f):
                  print(f"Missing test results: {f}", file=sys.stderr)
                  any_missing = True
                  continue
              try:
                  tree = ET.parse(f)
                  root = tree.getroot()
                  failed = int(root.get('failed') or 0)
                  if failed > 0:
                      print(f"{f}: failed={failed}", file=sys.stderr)
                  total_failed += failed
              except Exception as e:
                  print(f"Error parsing {f}: {e}", file=sys.stderr)
                  any_missing = True

          if any_missing:
              print('One or more test result files are missing or unreadable.', file=sys.stderr)
              sys.exit(2)

          if total_failed > 0:
              print(f"Tests failed: total failed = {total_failed}", file=sys.stderr)
              sys.exit(1)

          print('All Unity tests passed.')
          PY

      - name: Deactivate Unity license
        if: secrets.UNITY_LICENSE
        uses: game-ci/unity-actions/deactivate@v1
